# 消息队列调研报告

| 任务名称 | MYY-11 调研-消息队列    | 
|------|-------------------|
| 提交作者 | gsq               | 
| 提交时间 | 2024-08-14        | 
| 文件名  | mq_investigate.md | 

# 一、概述

## 1、相关背景

MYY的CDP需要处理来自IoT平台的数据，并进行数据加工处理。为了确保数据传输的可靠性、实时性和可扩展性，
我们需要选用合适的消息队列来实现数据传输和处理。
消息队列（MQ）作为一种异步通信机制，被广泛应用于分布式系统中。

选型参考

- 消息顺序：发送到队列的消息，消费时是否可以保证消费的顺序；
- 伸缩：当消息队列性能有问题，比如消费太慢，是否可以快速支持扩容；当消费队列过多，浪费系统资源，是否可以支持缩容。
- 消息留存：消息消费成功后，是否还会继续保留在消息队列。
- 容错性：当一条消息消费失败后，是否有一些机制，保证这条消息是一定能成功，比如异步第三方退款消息，需要保证这条消息消费掉，才能确定给用户退款成功，所以必须保证这条消息消费成功的准确性。
- 消息可靠性：是否会存在丢消息的情况，比如有A/B两个消息，最后只有B消息能消费，A消息丢失；
- 消息时序：主要包括“消息存活时间”和“延迟消息”；
- 吞吐量：支持的最高并发数；
- 消息路由：根据路由规则，只订阅匹配路由规则的消息，比如有A/B两者规则的消息，消费者可以只订阅A消息，B消息不会消费。

## 2、意义

- 选择合适的消息队列能够提高数据传输和处理的效率，确保系统的稳定性和可靠性。
- 消息队列的使用可以实现系统的解耦，提高系统的可扩展性和可维护性。
- 通过消息队列，可以实现数据的异步处理和缓冲，降低系统的压力。

# 二、业内方案调研

描述业内一般如何实现此功能，包括与此功能相关的现状、未来趋势；

对调研的方案进行对比**评价**和**对比分析**，论述各种方案的优劣势。

## 1、RabbitMQ

RabbitMQ是实现了高级消息队列协议（AMQP）的开源消息代理软件（亦称面向消息的中间件，Message-oriented middleware）。
RabbitMQ服务器是用Erlang语言编写的，而群集和故障转移是构建在开放电信平台框架上的。
所有主要的编程语言均有与代理接口通讯的客户端函式库。（维基百科）

优点

- 基于AMQP协议：除了Qpid，RabbitMQ是唯一一个实现了AMQP标准的消息服务器；
- 健壮、稳定、易用；
- 社区活跃，文档完善；
- 支持定时消息；
- 可插入的身份验证，授权，支持TLS和LDAP；
- 支持根据消息标识查询消息，也支持根据消息内容查询消息。

缺点

- erlang开发源码难懂，不利于做二次开发和维护；
- 接口和协议复杂，学习和维护成本较高。

总结

- erlang有并发优势，性能较好。虽然源码复杂，但是社区活跃度高，可以解决开发中遇到的问题；
- 业务流量不大的话可以选择功能比较完备的RabbitMQ。

## 2、Kafka

Kafka是由Apache软件基金会开发的一个开源流处理平台，由Scala和Java编写。 该项目的目标是为处理实时数据提供一个统一、高吞吐、低延迟的平台。
其持久化层本质上是一个“按照分布式事务日志架构的大规模发布/订阅消息队列”，这使它作为企业级基础设施来处理流式数据非常有价值。（维基百科）

优点

- 高吞吐量、低延迟：kafka每秒可以处理几十万条消息，它的延迟最低只有几毫秒；
- 可扩展性：kafka集群支持热扩展；
- 持久性、可靠性：消息被持久化到本地磁盘，并且支持数据备份防止数据丢失；
- 容错性：允许集群中节点故障，一个数据多个副本，少数机器宕机，不会丢失数据；
- 高并发：支持数千个客户端同时读写。

缺点

- 分区有序：仅在同一分区内保证有序，无法实现全局有序；
- 无延时消息：消费顺序是按照写入时的顺序，不支持延时消息
- 重复消费：消费系统宕机、重启导致offset未提交；
- Rebalance：Rebalance的过程中consumer group下的所有消费者实例都会停止工作，等待Rebalance过程完成。

使用场景

- 日志收集：大量的日志消息先写入kafka，数据服务通过消费kafka消息将数据落地；
- 消息系统：解耦生产者和消费者、缓存消息等；
- 用户活动跟踪：kafka经常被用来记录web用户或者app用户的各种活动，如浏览网页、搜索、点击等活动，这些活动信息被各个服务器发布到kafka的topic中，然后消费者通过订阅这些topic来做实时的监控分析，亦可保存到数据库；
- 运营指标：记录运营、监控数据，包括收集各种分布式应用的数据，生产各种操作的集中反馈，比如报警和报告；
- 流式处理：比如spark streaming

## 3、RocketMQ

RocketMQ是一个分布式消息和流数据平台，具有低延迟、高性能、高可靠性、万亿级容量和灵活的可扩展性。
RocketMQ是2012年阿里巴巴开源的第三代分布式消息中间件。（维基百科）

优点

- 支持发布/订阅（Pub/Sub）和点对点（P2P）消息模型；
- 顺序队列：在一个队列中可靠的先进先出（FIFO）和严格的顺序传递；
- 支持拉（pull）和推（push）两种消息模式；
- 单一队列百万消息的堆积能力；
- 支持多种消息协议，如 JMS、MQTT 等；
- 分布式横向扩展架构
- 满足至少一次消息传递语义；
- 提供丰富的Dashboard，包含配置、指标和监控等；
- 支持的客户端，目前是java、c++及golang

缺点

- 社区活跃度一般
- 延时消息：开源版不支持任意时间精度，仅支持特定的level

使用场景

- 为金融互联网领域而生，对于可靠性要求很高的场景

> 注： 参考rocketmq的架构和设计理念，几乎跟kafka很类似，架构几乎相同，
> 只是调整了相关的名词而已。当然在设计时，也确实针对kafka的问题做了改进，
> 比如kafka在权限设计上比较偷懒，能够支持的场景有限，
> rocketmq针对这部分就做了很多的设计，以满足丰富的权限需求。

# 三、业内方案评价和对比分析

| 方案       | 优势                    | 劣势                 |
|----------|-----------------------|--------------------|
| RabbitMQ | 支持多种消息传输模式，功能丰富       | 性能在高并发场景下稍逊，运维成本较高 |
| Kafka    | 高吞吐量，适合大规模数据传输，生态系统丰富 | 硬件资源需求高，运维复杂       |

# 名词解释

- **AMQP**：高级消息队列协议（Advanced Message Queuing Protocol），是一种提供统一消息服务的应用层标准高级消息队列协议。
- **RabbitMQ**：一个开源的消息代理软件，实现了AMQP协议。
- **Kafka**：一个分布式流处理平台，主要用于构建实时流数据管道和流应用。

# 附件及参考资料

- [RabbitMQ官网](https://www.rabbitmq.com/)
- [Kafka官网](https://kafka.apache.org/)
- [AMQP协议](https://www.amqp.org/)