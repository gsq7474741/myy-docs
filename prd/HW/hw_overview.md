# MY-T01需求文档

| 任务名称 | MYY-47 PRD-硬件详细PRD |     |
|------|--------------------|-----|
| 提交作者 | gsq                |     |
| 提交时间 | 2024-08-17         |     |
| 版本号  | V0.1               |     |
| 依赖版本 | 无                  |     |
| 文件名  | hw_overview.md     |     |

# 一、概述

开发一个物联网终端硬件设备，用于监测园林植物（如罗汉松）的数据和自动化干预。

型号：MY-T01

- MY：木易养项目
- T：终端设备
- 01：第一个版本

# 二、用户使用旅程

产品面向用户新购或现有的园林植物，用户在土建改造施工过程中为设备预备电源、水管、无线网络覆盖的等条件，每个植株部署一套设备，通过网络接入数据中台，为用户端微信小程序提供感知和执行能力。

# 三、硬件设计

## 1.功能设计

### 数据采集

产品需要具备以下几种数据的采集功能：

- 温度
- 湿度
- 光照
- 土壤温度
- 土壤水分
- 土壤氮磷钾
- 土壤EC
- 土壤PH

### 执行能力

- 产品具有控制1路电磁阀开闭的能力

### 供电

- 产品供电采用AC 220V接入

### 联网

- 产品采用WiFi接入互联网

## 2.物理设计

### 机械尺寸

- 产品尺寸控制在100mm*100mm*50mm以内
- 产品重量控制在500g以内

### MCU

- 选用乐鑫公司的ESP32系列MCU，型号ESP32-S3
- 使用ESP32-S3的官方模组`ESP32-S3-WROOM-1`，集成Flash、PSRAM、天线
	- layout设计需考虑后续更换为外置天线的模组`ESP32-S3-WROOM-1U`
- Flash容量至少为8MB
- PSRAM容量按需选取

### 传感器

- 温湿度传感器采用外置探头，I2C+自定义接口 或 Modbus-RTU协议+RS485接口
- 土壤采用7合1传感器探头，Modbus-RTU协议+RS485接口
- 光照传感器需自研外置探头，I2C或SPI协议+自定义接口

### 执行器

- 外置电磁阀，两种选项
	- DC供电MOS管驱动
	- AC供电继电器驱动

### 电源

- 220V接入，选用现成AC-DC模块方案
	- 对于DC电磁阀，模块至少20w功率
- 直流各部分之间可以考虑增加隔离电源
- 各个接口ESD保护

#### 【草稿】电源需求

| **主要芯片型号**    | **数量** | **供电电压** | **需求电流** | **功耗** |
|---------------|--------|----------|----------|--------|
| ESP32-WROOM-1 | 1      | 3V3      | 400mA    | 1.32W  |
| 温湿度探头         | 1      |          |          |        |
| 土壤探头          | 1      |          |          |        |
| 光照探头          | 1      |          |          |        |
| 电磁阀 DC        |        | 12V      |          | 14W    |
| 电磁阀 AC        |        | 220V     |          | 14W    |

#### 电源树

- AC 220V
	- 电磁阀（选项1）
	- AC-DC 12V
		- 电磁阀（选项2）
		- 继电器（选项1）
		- DC-DC 5V
			- 温湿度探头
			- 土壤探头
		- DC-DC 3V3
			- MCU
			- 光照探头
			- MOS驱动器（选项2）

### 外壳

- 防水接线盒，非金属
- 产品外壳颜色为黑色
- 线缆接口采用防水接头
	- 温湿度探头
	- 土壤探头
	- 光照探头
	- 电磁阀
	- 电源线
	- WiFi天线（未定）
- 考虑是否灌胶

# 四、软件设计

整个固件项目使用ESP-IDF进行开发，idf移植了FreeRTOS，可以调用rtos的多任务管理，ESP32-S3的双核CPU为并行任务处理提供了硬件支持。

系统框架采用idf的组件模式，将数据采集、外设控制、联网上报等功能作为独立组件进行开发，各组件对外暴露接口，供主程序调用。主程序使用freertos的任务机制，将每个组件提供的能力作为task调度。

## 系统框架

- 功能描述：开发环境和程序运行框架。
- 功能点：
	1. 按ESP32-S3芯片配置合适的config
	2. 规划Flash使用，划分分区表
	3. 设计合理的项目结构，解耦各个组件
	4. 协调各子系统开发
	5. 持续集成，测试整体功能
- 相关信息：ESP-IDF、CMake、Git、测试、CI/CD
- 异常情况及处理：按具体情况处理
- 备注：熟悉ESP-IDF、CMake

## 数据采集组件

- 功能描述：从各个传感器探头读取数据，封装为统一的数据对象。
- 功能点：
	1. 支持多种传感器，对每种传感器使用不同协议进行读写与配置。
	2. 对外封装，只暴露配置、开始、结束等高层接口，屏蔽传感器操作细节
	3. 按需配置传感器，可调精度、采样时间、量程等
	4. 正确处理各种数值格式转换
- 相关信息：各种接口定义、协议格式、传感器开发资料
- 异常情况及处理：传感器出现异常时对外发送事件
- 备注：需要看资料和库文档，调用对应协议的功能

## 外设控制组件

- 功能描述：控制电磁阀的开启与关闭
- 功能点：
	1. 提供接口，控制电磁阀开闭
	2. 获取电磁阀当前开闭状态
- 相关信息：MOS管、继电器、
- 异常情况及处理：无。

## 物联网平台适配组件

- 功能描述：将数据和事件上报至物联网平台，提供服务调用接口
- 功能点：
	1. 轮询传感器及执行器状态，读取数据
	2. 调用其他组件提供的功能
	3. 支持JSON格式数据
	4. 与IoT平台交互，使用对应的sdk或mqtt上报数据
	5. 响应IoT平台指令，调用对应功能、远程配置设备、远程运维
	6. OTA升级功能
- 相关信息：JSON、iot平台、mqtt、回调&轮询、OTA
- 异常情况及处理：按具体情况处理。
- 备注：C/C++多一些，不太涉及硬件

# 五、技术栈

- 软件
	- 语言：C/C++、Python
	- 构建系统：CMake
	- IDE：CLion
	- 版本控制工具：Git、GitHub
- 硬件
	- 制造：嘉立创EDA、SMT、电烙铁焊接、风枪
	- 仪器：万用表、示波器
	- 协议：I2C、SPI、Modbus-RTU

# 六、性能需求

- 稳定运行，不产生软件错误
- 工作温度-20~60°C
- 防水防尘，可承受带压水喷淋
- 数据上报频率：可调，常规5-10分钟/次，实时模式5秒/次。
- 各个外设探头可插拔更换
- 设计寿命3年以上

# 七、安全性

- 使用正规厂家、有认证的电源模块
- 电源各部分留出冗余
- AC-DC模块符合安规、带有自恢复保险丝
- 电磁阀控制部分电路设计合理
- 隔离传感器
- 防雷、防静电
- 机械强度达标

# 八、项目限制

- 研发预算：5000元以下
- 小批量设备成本：设备物料（零售价格）+加工（打样价格），平均每套700元以下
- 开发周期：2个月

# 九、验收标准

- 正确收集数据
- 成功控制电磁阀开闭
- 对接iot平台，可实现物模型定义的功能
- 稳定运行7d以上
- 可承受喷淋水
- 家庭无线电环境下，与10米内路由器建立稳定WiFi连接
- 通过实地测试

# 十、风险评估

- 开发时间紧张，可能需要优先实现核心功能
- 技术路线不确定，可能需要更改选型和方案
- 预算超标



